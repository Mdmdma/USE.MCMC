<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Insights on nearest neighbor search • USE.MCMC</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Insights on nearest neighbor search">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">USE.MCMC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/development_vignette.html">Development Vignette</a></li>
    <li><a class="dropdown-item" href="../articles/insights-on-MCMC-pseudo-absence-sampling-vignette.html">Insights on MCMC pseudo absence sampling vignette</a></li>
    <li><a class="dropdown-item" href="../articles/Insights-on-nearest-neighbor-search.html">Insights on nearest neighbor search</a></li>
    <li><a class="dropdown-item" href="../articles/USE_vignette.html">USE vignette</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mdmdma/USE.MCMC/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Insights on nearest neighbor search</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mdmdma/USE.MCMC/blob/main/vignettes/Insights-on-nearest-neighbor-search.Rmd" class="external-link"><code>vignettes/Insights-on-nearest-neighbor-search.Rmd</code></a></small>
      <div class="d-none name"><code>Insights-on-nearest-neighbor-search.Rmd</code></div>
    </div>

    
    
<p>This vignette gives some insights on the concept of nearest neighbor
search in the context of uniform sampling.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mdmdma.github.io/USE.MCMC/">USE.MCMC</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearth/" class="external-link">rnaturalearth</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearthdata/" class="external-link">rnaturalearthdata</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">FNN</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://borisleroy.com/virtualspecies/" class="external-link">virtualspecies</a></span><span class="op">)</span></span></code></pre></div>
<p>The foundation of the approach is the assumption that we can map a
point in various dimensions to real points in our environment using
distance as the metric that tells us which point matches best.</p>
<p>In the geographical space this concept is very intuitive. The closest
city to a given test point is the one with the least distance.</p>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/geographical-space-example-part-2-1.png" width="672"></p>
<p>In this case Venice is closest to the test point. If we want to get a
real point from our test point using geographical distance as out metric
we would therefore choose Venice.</p>
<p>We can now do the same thing in the environmental space. To start
lets build an example with just two dimensions. As an example we can
look at bioclimatical variables 14 and 15. Bioclim 14 denotes the
precipitation of the driest month, bioclim 15 the precipitation
seasonality.</p>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/env-example-1.png" width="672"></p>
<p>Now Naples is the closest location. In this case the term distance is
still somewhat sound, as both axis have the units mm. It starts to fall
apart when axis to not share the same units, as is unclear how the
scales of the data compare. In this fabricated case, dimensions of
similar scale were chosen, but this is not necessarily the case. As an
example bioclim 4 has values ranging between 200 and 900 in Europe. How
these variables are scaled to get meaningful results is not clear. One
way to evade this issue is to perform a PCA. In this case the different
scales of the axis are explained by the respective variability that can
be explained with the axis. The unit of the “distance” loses its
interpretability, as it will be a mix between temperature and
precipitation. Non the less we can find environmentally similar points
by selecting the point with the shortest distance to our test
points.</p>
<p>Lets look at a example of our test points when performing a principle
component analysis on five bioclim variables(3, 4, 9, 14, 15).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">rpc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rastPCA.html">rastPCA</a></span><span class="op">(</span><span class="va">env.data.raster</span>,  stand <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">env.data.raster.with.pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rpc</span><span class="op">$</span><span class="va">PCs</span> , <span class="va">env.data.raster</span><span class="op">)</span></span></code></pre></div>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/plot-pca-example%20-1.png" width="672"></p>
<p>Looking at the first two principal components we see that the test
point is climate wise closest to Turin, while still being far. In
addition we see that the distance to Naples, Milan and Venice is not
much higher. The distance gives us a indication on how similar the best
match is. In this case it would probably be sound to say that no good
match was found. As our environmental space only contained 7 points this
is no surprise. Luckily for us there are more then seven measurement
stations in Europe and satellites can provide high resolution data for
areas without measurement devices on the ground. At a resolution of 2.5
arc minutes there are over 18’000 data points in western Europe.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dimensions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PC1"</span>, <span class="st">"PC2"</span><span class="op">)</span></span>
<span><span class="va">env.data.sf</span> <span class="op">&lt;-</span> <span class="va">env.data.raster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span>xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">env.data</span><span class="op">&lt;-</span> <span class="va">env.data.raster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span>xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">env.with.pc</span> <span class="op">&lt;-</span> <span class="va">rpc</span><span class="op">$</span><span class="va">PCs</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">env.with.pc</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/na.omit.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">env.data.sf</span><span class="op">)</span></span>
<span></span>
<span><span class="va">env.with.pc.sf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">env.with.pc</span>, coords <span class="op">=</span> <span class="va">dimensions</span><span class="op">)</span></span></code></pre></div>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/env-in-pc-plot-1.png" width="672">
Now lets explore how we can use the nearest neighbor mapping can help us
to uniformly sample points out of this environmental space.</p>
<p>If we would randomly pick points out of the set of points in the
environment we would recreate the distribution of points in the
environment and not get a flat, uniform, distribution.</p>
<p>The main principle of the proposed method is that we create a grid of
uniformly spaced points, map them back to real points in the environment
and then use statistics of the distances to exclude points that had
their origin in a region that was too far away from the real points.
This works with the assumption that the environment is made up by
connected points.</p>
<p>The function [<code><a href="../reference/paSamplingNn.html">paSamplingNn()</a></code>][USE.MCMC::paSamplingNn]
performs this sampling given the environmental space. Lets look under
its hood to understand how it works.</p>
<p>In a first step we need to provide the parameters we want to
control.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid.res</span> <span class="op">&lt;-</span> <span class="fl">15</span></span>
<span><span class="va">num.samples.per.cell</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">dimensions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PC1"</span>, <span class="st">"PC2"</span><span class="op">)</span></span></code></pre></div>
<p>We now compute a uniformly spaced grid that covers the whole
environmental range.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># compute the grid cells</span></span>
<span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html" class="external-link">st_make_grid</a></span><span class="op">(</span><span class="va">env.with.pc.sf</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">grid.res</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span> <span class="op">=</span> <span class="va">dimensions</span></span></code></pre></div>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/plot-grid-1.png" width="672"></p>
<p>As we may want multiple points sampled from the same grid cell, we
repeat the grid the respective number of times.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid.repeated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">num.samples.per.cell</span>,</span>
<span>                                          <span class="va">grid</span>,</span>
<span>                                          simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>So far this would does not work, these repeated points would all map
to the same nearest neighbor in the environment. In addition to that the
grid adds a bias to the sampled points.</p>
<p>To eliminate this issue we add uniform noise in the range of the grid
spacing to the points. Thereby we loose the grid bias, and sample from
random location in each grid cell, while on larger scales still
conserving uniform sampling. In addition to that we can now sample
multiple points from the same grid cell, as the noise is different for
each point.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">step.scaling</span> <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="va">step.x</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">grid</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">grid</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">step.scaling</span></span>
<span><span class="va">step.y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">grid</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">grid</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">step.scaling</span></span>
<span></span>
<span><span class="va">noise.x</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">grid.repeated</span><span class="op">)</span>, <span class="op">-</span><span class="va">step.x</span>, <span class="va">step.x</span><span class="op">)</span></span>
<span><span class="va">noise.y</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">grid.repeated</span><span class="op">)</span>, <span class="op">-</span><span class="va">step.y</span>, <span class="va">step.y</span><span class="op">)</span></span>
<span><span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">noise.y</span>, <span class="va">noise.x</span><span class="op">)</span></span>
<span><span class="va">grid.noisy</span> <span class="op">&lt;-</span> <span class="va">grid.repeated</span> <span class="op">+</span> <span class="va">noise</span></span></code></pre></div>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/add-noise-to-grid-plot-1.png" width="672"></p>
<p>We have reached the main concept of this approach. So far the points
on the grid are not present in the real dataset. For each point in the
repeated noisy grid we search the closest neighbor in the real
environmental space. This is implement with the FNN package. By using a
KD-tree, it can handle large data sets in higher dimensions quickly.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapped.sampled.point.data</span> <span class="op">&lt;-</span> <span class="fu">FNN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FNN/man/get.knn.html" class="external-link">get.knnx</a></span><span class="op">(</span><span class="va">env.with.pc</span><span class="op">[</span><span class="va">dimensions</span><span class="op">]</span>, </span>
<span>                                           <span class="va">grid.noisy</span>, k <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">mapped.sampled.points</span> <span class="op">&lt;-</span> <span class="va">env.with.pc</span><span class="op">[</span><span class="va">mapped.sampled.point.data</span><span class="op">$</span><span class="va">nn.index</span>,<span class="op">]</span></span>
<span><span class="va">mapped.sampled.points</span><span class="op">$</span><span class="va">distance</span> <span class="op">&lt;-</span> <span class="va">mapped.sampled.point.data</span><span class="op">$</span><span class="va">nn.dist</span></span></code></pre></div>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/remapp-points-plot-1.png" width="672"></p>
<p>Now we have points distributed nearly uniformely in the environment.
The issue remaining is that we oversampled the border regions, as even
cells that did not contain any points where remapped to the closest
point, even if that point was in a different grid cell. We now have
different options on how to set the distance threshold at which we
denote points to have originated too far away.</p>
<p>One option is to use the cell size as the limiting factor. By setting
the distance threshold to be halve the cell size, we can eliminate
points that where sampled in empty cells. This approach depends on
having chosen the cell size well. We can look at the limits.</p>
<p>If we set the grid size to one, we only have one cell. The distance
threshold would be very large, we would not remove any points and
oversample the border regions.</p>
<p>On the other hand if the cell size is too small, the threshold will
be very small. In the areas with low point densities there will be a lot
of points where the distance to the next point is too large. On first
look this is no issue, as these points stem from “empty” grid sells. The
issue emerges in areas with a high point density. Here there will be no
empty cells. Thus at the low limit these areas will be oversampled.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">distance.threshold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">step.y</span>, <span class="va">step.x</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="va">mapped.sampled.points.filtered</span> <span class="op">&lt;-</span> <span class="va">mapped.sampled.points</span><span class="op">[</span></span>
<span>  <span class="va">mapped.sampled.points</span><span class="op">$</span><span class="va">distance</span> <span class="op">&lt;</span> <span class="va">distance.threshold</span>, <span class="op">]</span></span></code></pre></div>
<p>Luckly we have additional information. The original dataset itself
gives us some indication what kind of distances are normal. By searching
the closest few, but at least more then number of points per gridcell,
neighbors, we can compute a histogramm of the distance between points in
the original data</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nearest.neighbors.distance</span><span class="op">&lt;-</span> <span class="fu">FNN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FNN/man/knn.dist.html" class="external-link">knn.dist</a></span><span class="op">(</span><span class="va">env.with.pc</span><span class="op">[</span><span class="va">dimensions</span><span class="op">]</span>,</span>
<span>                                           k<span class="op">=</span><span class="va">num.samples.per.cell</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/plot-distance-histogram-1.png" width="672"><img src="Insights-on-nearest-neighbor-search_files/figure-html/plot-distance-histogram-cut-1.png" width="672">
We see that the distance histogram is dominated by the low distances
originating in regions with high densities. If we look at the top end on
the other hand, we get information on the spacing of areas with a low
point density. We probably do not want to take the maximal distance as
our threshold, as the dataset could contain outlayers. We can sort the
the vector containing the distances and take a value with some safty
threshold from the extreme values.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sorted.nearest.neighbor.distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">nearest.neighbors.distance</span>, </span>
<span>                                          decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">distance.threshold</span> <span class="op">&lt;-</span> <span class="va">sorted.nearest.neighbor.distances</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="fl">2</span></span>
<span></span>
<span><span class="va">mapped.sampled.points.filtered</span> <span class="op">&lt;-</span> <span class="va">mapped.sampled.points</span><span class="op">[</span></span>
<span>  <span class="va">mapped.sampled.points</span><span class="op">$</span><span class="va">distance</span> <span class="op">&lt;</span> <span class="va">distance.threshold</span>, <span class="op">]</span></span></code></pre></div>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/mapped-points-plots-1.png" width="672"></p>
<p>It can still happen that we map two sampled points to the same real
point. These points should be removed, as they do not provide additional
information. The probability to map twice to the same point is
correlated the the distance threshold. Especially at the borders of the
environment the probability to map twice to the same point its high, as
there is only one direction in which a neighbor can lay, in difference
to points inside of the environment for which two directions in which a
nearest neighbor can be found. This leads to some oversampling. It is
not trivial how to eliminate this issue.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapped.sampled.points.filtered.unique</span> <span class="op">&lt;-</span> <span class="va">mapped.sampled.points.filtered</span><span class="op">[</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">mapped.sampled.points.filtered</span><span class="op">[[</span><span class="st">"PC1"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/removed-dublicates-plot-1.png" width="672">
We can see that the chosen threshold is reasonable, as it reduces the
oversampling in border regions well without removing points in areas
that we think to be part of the environment.</p>
<p>This threshold method can also be used to estimate a upper bound to
the useful grid resolution. A function that provides this functionality
is given by [<code>maxresNn()</code>][USE.MCMC::maxResNn].</p>
<p>In difference to the original
[<code><a href="../reference/paSampling.html">paSampling()</a></code>][USE.MCMC::paSampling] method this approach
should still converge to uniform sampling for too low grid resolutions.
The issue here is that it can not be the guaranteed that the
distribution is flat for small sample sizes. The deviations from uniform
sampling are not expected to be at the same position as the high point
density areas of the underlying distribution</p>
<p>From here we can use the same approach as in the original method to
exclude points that have properties that coincide with the presence
species.</p>
<p>We can generate a sample species:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">virtual.presence.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getVirtualSpeciesPresencePoints.html">getVirtualSpeciesPresencePoints</a></span><span class="op">(</span></span>
<span>  env.data <span class="op">=</span> <span class="va">env.data.raster</span>, n.samples <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 300</span></span>
<span><span class="va">virtual.presence.points</span> <span class="op">&lt;-</span> <span class="va">virtual.presence.data</span><span class="op">$</span><span class="va">sample.points</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occ.vec</span> <span class="op">&lt;-</span> <span class="va">virtual.presence.points</span></span>
<span><span class="va">thres</span> <span class="op">=</span> <span class="fl">0.7</span></span>
<span><span class="va">id_rast</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span>vals<span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">env.data.raster</span><span class="op">)</span>,</span>
<span>                       names <span class="op">=</span><span class="st">"myID"</span>,</span>
<span>                       extent <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">env.data.raster</span><span class="op">)</span>,</span>
<span>                       nrows <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">env.data.raster</span><span class="op">)</span>,</span>
<span>                       ncols <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">env.data.raster</span><span class="op">)</span>,</span>
<span>                       crs <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">env.data.raster</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">abio.st</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">id_rast</span>, <span class="va">env.data.raster</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">id_rast</span>, <span class="va">rpc</span><span class="op">$</span><span class="va">PCs</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PC1"</span>, <span class="st">"PC2"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">PC12occ</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">id_rast</span>,  <span class="va">occ.vec</span>, cells <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                          df <span class="op">=</span> <span class="cn">FALSE</span>, ID<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">PC12ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/na.omit.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">dt</span>, PA<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">dt</span><span class="op">$</span><span class="va">myID</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="va">PC12occ</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">H</span> <span class="op">&lt;-</span> <span class="fu">ks</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ks/man/Hpi.html" class="external-link">Hpi</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC12ex</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PC1"</span>, <span class="st">"PC2"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">estimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>KDE <span class="op">=</span> <span class="fu">ks</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ks/man/kde.html" class="external-link">kde</a></span><span class="op">(</span><span class="va">PC12ex</span><span class="op">[</span><span class="va">PC12ex</span><span class="op">$</span><span class="va">PA</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PC1"</span>, <span class="st">"PC2"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                                     eval.points <span class="op">=</span> <span class="va">PC12ex</span><span class="op">[</span><span class="va">PC12ex</span><span class="op">$</span><span class="va">PA</span> <span class="op">==</span><span class="fl">1</span>,</span>
<span>                                                          <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PC1"</span>, <span class="st">"PC2"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                                     h <span class="op">=</span> <span class="va">H</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>                       <span class="va">PC12ex</span><span class="op">[</span><span class="va">PC12ex</span><span class="op">$</span><span class="va">PA</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PC1"</span>, <span class="st">"PC2"</span>, <span class="st">"myID"</span>, <span class="st">"PA"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">quantP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">[</span>, <span class="st">"KDE"</span><span class="op">]</span>, <span class="va">thres</span><span class="op">)</span></span>
<span><span class="va">estimate</span><span class="op">$</span><span class="va">percP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">$</span><span class="va">KDE</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">quantP</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="st">"out"</span>, <span class="st">"in"</span><span class="op">)</span></span>
<span><span class="va">point.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC12ex</span>, </span>
<span>                    y <span class="op">=</span> <span class="va">estimate</span><span class="op">[</span><span class="va">estimate</span><span class="op">$</span><span class="va">PA</span> <span class="op">==</span> <span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"myID"</span>,<span class="st">"percP"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                  by <span class="op">=</span> <span class="st">"myID"</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">point.data</span><span class="op">$</span><span class="va">percP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">point.data</span><span class="op">$</span><span class="va">percP</span><span class="op">)</span>, <span class="st">"pabs"</span>,<span class="va">point.data</span><span class="op">$</span><span class="va">percP</span><span class="op">)</span></span>
<span><span class="va">chull</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">point.data</span>, <span class="va">point.data</span><span class="op">$</span><span class="va">percP</span><span class="op">==</span><span class="st">"in"</span>, </span>
<span>                             select<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"PC1"</span>,<span class="st">"PC2"</span> <span class="op">)</span><span class="op">)</span>,</span>
<span>                      coords<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"PC1"</span>,<span class="st">"PC2"</span> <span class="op">)</span><span class="op">)</span></span>
<span><span class="va">chull</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="va">chull</span><span class="op">)</span></span>
<span><span class="va">chull</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_convex_hull</a></span><span class="op">(</span><span class="va">chull</span><span class="op">)</span></span>
<span><span class="va">point.data.sf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">mapped.sampled.points.filtered.unique</span>,</span>
<span>                              coords<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"PC1"</span>,<span class="st">"PC2"</span> <span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outside.the.region.with.presence</span> <span class="op">&lt;-</span> <span class="va">point.data.sf</span><span class="op">[</span><span class="op">!</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_within</a></span><span class="op">(</span><span class="va">point.data.sf</span>,</span>
<span>                               <span class="va">chull</span>, sparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Reorganize the columns of the sf object so that the output is more convenient</span></span>
<span><span class="va">sampled.points.absence</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">outside.the.region.with.presence</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sampled.points.absence</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PC1"</span>, <span class="st">"PC2"</span><span class="op">)</span></span>
<span><span class="va">sampled.points.without.points.not.assosiated.with.the.species</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">outside.the.region.with.presence</span><span class="op">)</span>,</span>
<span>  <span class="va">sampled.points.absence</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">virtual.presence.points.pc</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">env.data.raster.with.pc</span>,</span>
<span>                                             <span class="va">virtual.presence.points</span>,</span>
<span>                                             bind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">virtual.presence.points.pc</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"Presence"</span></span>
<span><span class="va">virtual.presence.points.pc</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_set_crs</a></span><span class="op">(</span><span class="va">virtual.presence.points.pc</span>, <span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/plot-sampled-point-with-pres-differenciated-1.png" width="672"></p>
<p>We can also plot the plots in the real geographical space.</p>
<p><img src="Insights-on-nearest-neighbor-search_files/figure-html/plot-in-geographical-space-1.png" width="672"></p>
<p>We can see that the points that where uniformly sampled in the
environmental space are not evenly spaced any more. Areas with large
environmental gradients get sampled more often.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mathis Erler, Daniele Da Re, Enrico Tordoni, Manuele Bazzichetto.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
